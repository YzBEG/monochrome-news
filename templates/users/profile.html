{% extends 'base.html' %}
{% load static %}

{% block title %}{{ profile_user.username }} | MONOCHROME NEWS{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
<section class="hero hero-medium">
    <div class="video-container">
        <div style="width:100%; height:100%; background: linear-gradient(45deg, #000000 0%, #222222 100%);">
        </div>
    </div>
    
    <div class="video-overlay"></div>
    
    <div class="hero-content">
        <h1 class="hero-title">{{ profile_user.username }}</h1>
        <p>{{ profile_user.profile.bio|default:"Пользователь MONOCHROME NEWS"|truncatechars:100 }}</p>
    </div>
</section>

<section class="products">
    <div class="container">
        <div class="profile-header">
            {% if profile_user.profile.avatar %}
            <img src="{{ profile_user.profile.avatar.url }}" alt="{{ profile_user.username }}" class="profile-avatar">
            {% else %}
            <div class="profile-avatar" style="background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-user" style="font-size: 48px; color: rgba(255,255,255,0.3);"></i>
            </div>
            {% endif %}
            
            <div class="profile-info">
                <h1>
                    {{ profile_user.username }}
                    <span class="online-status {% if profile_user.profile.is_online %}online{% else %}offline{% endif %}">
                        <i class="fas fa-circle"></i>
                        {% if profile_user.profile.is_online %}
                        Онлайн
                        {% else %}
                        Был(а) {{ profile_user.profile.last_seen|date:"d.m.Y H:i"|default:"недавно" }}
                        {% endif %}
                    </span>
                </h1>
                
                {% if profile_user.profile.bio %}
                <div class="profile-bio">
                    {{ profile_user.profile.bio|linebreaks }}
                </div>
                {% endif %}
                
                <div class="profile-meta">
                    {% if profile_user.profile.website %}
                    <div class="profile-meta-item">
                        <i class="fas fa-globe"></i>
                        <a href="{{ profile_user.profile.website }}" target="_blank" style="color: inherit;">Сайт</a>
                    </div>
                    {% endif %}
                    
                    {% if profile_user.profile.birth_date %}
                    <div class="profile-meta-item">
                        <i class="fas fa-birthday-cake"></i>
                        {{ profile_user.profile.birth_date|date:"d.m.Y" }}
                    </div>
                    {% endif %}
                    
                    <div class="profile-meta-item">
                        <i class="fas fa-calendar-plus"></i>
                        На сайте с {{ profile_user.date_joined|date:"d.m.Y" }}
                    </div>
                </div>
            </div>
        </div>

        <h2 style="margin-bottom: 20px; color: #fff;">Статистика</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ profile_user.profile.get_post_count }}</div>
                <div class="stat-label">Новостей</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{ profile_user.profile.get_comment_count }}</div>
                <div class="stat-label">Комментариев</div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: #fff;">Последняя активность</h2>
            <span style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">
                Всего активностей: {{ profile_user.profile.get_total_activity }}
            </span>
        </div>
        
        <div class="activity-timeline">
            {% with activities=profile_user.profile.get_recent_activity %}
                {% if activities %}
                    {% for activity in activities %}
                    <div class="activity-item">
                        <div class="activity-icon">
                            {% if activity.type == 'post' %}
                            <i class="fas fa-newspaper icon-post"></i>
                            {% elif activity.type == 'comment' %}
                            <i class="fas fa-comment icon-comment"></i>
                            {% elif activity.type == 'like' %}
                            <i class="fas fa-thumbs-up icon-like"></i>
                            {% elif activity.type == 'dislike' %}
                            <i class="fas fa-thumbs-down icon-dislike"></i>
                            {% elif activity.type == 'login' %}
                            <i class="fas fa-sign-in-alt icon-login"></i>
                            {% else %}
                            <i class="fas fa-eye icon-view"></i>
                            {% endif %}
                        </div>
                        
                        <div class="activity-content">
                            <div class="activity-message">
                                {{ activity.message }}
                            </div>
                            <div class="activity-time">
                                {{ activity.time|date:"d.m.Y H:i" }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="no-activity">
                    <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 15px; display: block; color: rgba(255,255,255,0.1);"></i>
                    <p>Пока нет активности</p>
                </div>
                {% endif %}
            {% endwith %}
        </div>

        <div class="user-posts-header">
            <h2>Новости пользователя</h2>
            <span style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">
                Всего: {{ user_posts|length }}
            </span>
        </div>
        
        <div class="products-grid">
            {% for post in user_posts %}
            <div class="product-card glitch-on-hover">
                {% if post.image %}
                <div class="product-image">
                    <img src="{{ post.image.url }}" alt="{{ post.title }}">
                </div>
                {% else %}
                <div class="product-image">
                    <i class="fas fa-newspaper"></i>
                </div>
                {% endif %}
                <div class="product-content">
                    <h3>{{ post.title }}</h3>
                    <p>{{ post.content|truncatechars:120 }}</p>
                    
                    <div class="product-meta">
                        <div class="meta-author">
                            <i class="fas fa-user"></i>
                            <a href="{% url 'profile' username=post.author.username %}" class="user-link">
                                {{ post.author.username }}
                            </a>
                        </div>
                        <div class="meta-date">
                            <i class="fas fa-calendar"></i>
                            <span>{{ post.created_at|date:"d.m.Y" }}</span>
                        </div>
                    </div>
                    
                    <div class="post-stats">
                        <span>
                            <i class="fas fa-thumbs-up"></i> {{ post.likes_count }}
                        </span>
                        <span>
                            <i class="fas fa-thumbs-down"></i> {{ post.dislikes_count }}
                        </span>
                        <span>
                            <i class="fas fa-comment"></i> {{ post.comments_count }}
                        </span>
                    </div>
                    
                    <a href="/posts/{{ post.id }}/" class="read-more-btn">
                        <span>Читать далее</span>
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </div>
            {% empty %}
            <div class="no-posts" style="grid-column: 1 / -1;">
                <i class="fas fa-newspaper"></i>
                <h3>Пока нет новостей</h3>
                <p>Пользователь еще не опубликовал ни одной новости</p>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function updateOnlineStatus() {
        const statusElement = document.querySelector('.online-status');
        if (!statusElement) return;
        if (window.authService && window.authService.isAuthenticated()) {
            fetch('/api/heartbeat/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${window.authService.accessToken}`,
                    'Content-Type': 'application/json'
                }
            }).catch(() => {  });
        }
    }
    
    setInterval(updateOnlineStatus, 30000);
    
    updateOnlineStatus();
});
</script>
{% endblock %}